# =============================================================================
# DOCKERFILE SIMPLIFICADO PARA EASYPANEL
# =============================================================================

FROM python:3.11-slim

# Instalar dependências do sistema
RUN apt-get update && apt-get install -y \
    postgresql-15 \
    postgresql-client-15 \
    postgresql-contrib-15 \
    redis-server \
    supervisor \
    curl \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

# Configurar diretório da aplicação
WORKDIR /app

# Copiar requirements e instalar dependências Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copiar código da aplicação
COPY . .

# Criar diretórios necessários
RUN mkdir -p /app/logs /app/data /var/log/supervisor /var/lib/postgresql/15/main /var/run/postgresql

# Configurar PostgreSQL
RUN chown -R postgres:postgres /var/lib/postgresql/ /var/run/postgresql/
RUN chmod 755 /var/run/postgresql

# Inicializar banco PostgreSQL
USER postgres
RUN /usr/lib/postgresql/15/bin/initdb -D /var/lib/postgresql/15/main --encoding=UTF-8 --locale=C
RUN echo "host all all 0.0.0.0/0 md5" >> /var/lib/postgresql/15/main/pg_hba.conf
RUN echo "listen_addresses='*'" >> /var/lib/postgresql/15/main/postgresql.conf
RUN echo "port = 5432" >> /var/lib/postgresql/15/main/postgresql.conf

USER root

# Criar script de inicialização
RUN cat > /app/start-services.sh << 'EOF'
#!/bin/bash
set -e

echo "🚀 Iniciando serviços..."

# Iniciar PostgreSQL
echo "📊 Iniciando PostgreSQL..."
su - postgres -c '/usr/lib/postgresql/15/bin/pg_ctl -D /var/lib/postgresql/15/main -l /var/log/postgresql.log start'

# Aguardar PostgreSQL
echo "⏳ Aguardando PostgreSQL..."
until pg_isready -h localhost -p 5432; do
  sleep 1
done

# Criar usuário e banco
echo "🔧 Configurando banco..."
su - postgres -c "psql -c \"CREATE USER orchestrator_user WITH SUPERUSER PASSWORD '${DB_PASSWORD:-orchestrator_pass}';\""
su - postgres -c "createdb -O orchestrator_user orchestrator" || true

# Executar script SQL de inicialização
if [ -f /app/scripts/init-db.sql ]; then
    echo "📋 Executando init-db.sql..."
    su - postgres -c "psql -d orchestrator -f /app/scripts/init-db.sql"
fi

# Iniciar Redis
echo "🔴 Iniciando Redis..."
redis-server --daemonize yes --bind 0.0.0.0 --port 6379

# Aguardar Redis
echo "⏳ Aguardando Redis..."
until redis-cli ping; do
  sleep 1
done

# Executar migrations
echo "🔄 Executando migrations..."
cd /app
python -c "
import asyncio
import sys
import os
sys.path.append('/app')

# Configurar variáveis de ambiente
os.environ.setdefault('DB_HOST', 'localhost')
os.environ.setdefault('DB_PORT', '5432')
os.environ.setdefault('DB_NAME', 'orchestrator')
os.environ.setdefault('DB_USER', 'orchestrator_user')
os.environ.setdefault('DB_PASSWORD', 'orchestrator_pass')

try:
    from app.database.migrations import run_migrations
    
    DB_CONFIG = {
        'host': os.getenv('DB_HOST'),
        'port': int(os.getenv('DB_PORT', '5432')),
        'database': os.getenv('DB_NAME'),
        'user': os.getenv('DB_USER'),
        'password': os.getenv('DB_PASSWORD')
    }
    
    async def main():
        try:
            await run_migrations(DB_CONFIG)
            print('✅ Migrations executadas com sucesso!')
        except Exception as e:
            print(f'⚠️ Migrations falharam (continuando): {e}')
    
    asyncio.run(main())
except Exception as e:
    print(f'⚠️ Erro ao importar migrations (continuando): {e}')
"

echo "🎉 Serviços iniciados! Iniciando aplicação..."

# Iniciar aplicação
exec python -m uvicorn app.main_orchestrator:app --host 0.0.0.0 --port 8000
EOF

RUN chmod +x /app/start-services.sh

# Expor porta da aplicação
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1

# Comando de inicialização
CMD ["/app/start-services.sh"]