# Dockerfile otimizado para deploy GitHub via EasyPanel
FROM python:3.11-slim-bookworm

# Instalar dependências do sistema: ffmpeg (essencial) e ca-certificates (para HTTPS)
# Limpar cache do apt para reduzir o tamanho da imagem
RUN apt-get update && \
    apt-get install -y --no-install-recommends ffmpeg ca-certificates && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Definir o diretório de trabalho dentro do container
WORKDIR /app

# Copiar apenas o arquivo de dependências primeiro para aproveitar o cache do Docker
COPY app/requirements.txt .

# Instalar as dependências Python
RUN python -m pip install --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Copiar somente o necessário para o worker
COPY app/fingerv7.py .
# Se você usa o streams.json como fallback inicial, copie-o também:
# COPY app/streams.json .

# Criar usuário não-root e permissões para a aplicação
RUN adduser --disabled-password --gecos "" appuser && \
    mkdir -p /app/segments && \
    chown -R appuser:appuser /app

# Saída sem buffer para logs em tempo real
ENV PYTHONUNBUFFERED=1

# Executar como usuário não-root
USER appuser

# Comando de inicialização da aplicação
CMD ["python", "fingerv7.py"]